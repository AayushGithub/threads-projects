"use strict";!function(e,t){for(var n in t)Object.defineProperty(e,n,{enumerable:!0,get:t[n]})}(exports,{DEFAULT_DEVICE:function(){return d},ThreadsAPI:function(){return c}});var e=require("axios"),t=require("fs"),n=require("mime-types"),r=require("uuid"),a=require("./constants"),s=require("./dynamic-data");function o(e,t,n,r,a,s,o){try{var i=e[s](o),u=i.value}catch(e){n(e);return}i.done?t(u):Promise.resolve(u).then(r,a)}function i(e){return function(){var t=this,n=arguments;return new Promise(function(r,a){var s=e.apply(t,n);function i(e){o(s,r,a,i,u,"next",e)}function u(e){o(s,r,a,i,u,"throw",e)}i(void 0)})}}function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function l(e,t){var n,r,a,s,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(n)throw TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&s[0]?r.return:s[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,s[1])).done)return a;switch(r=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===s[0]||2===s[0])){o=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){o.label=s[1];break}if(6===s[0]&&o.label<a[1]){o.label=a[1],a=s;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(s);break}a[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}var d={manufacturer:"OnePlus",model:"ONEPLUS+A3010",os_version:25,os_release:"7.1.1"},c=function(o){"use strict";var c=this;this.verbose=!1,this.token=void 0,this.fbLSDToken=a.DEFAULT_LSD_TOKEN,this.noUpdateToken=!1,this.noUpdateLSD=!1,this.deviceID=a.DEFAULT_DEVICE_ID,this.device=d,this._getAppHeaders=function(){return u({"User-Agent":"Barcelona "+s.LATEST_ANDROID_APP_VERSION+" Android","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},c.token?{Authorization:"Bearer IGT:2:"+c.token}:void 0)},this._getDefaultHeaders=function(e){return u({},c._getAppHeaders(),{authority:"www.threads.net",accept:"*/*","accept-language":"ko","cache-control":"no-cache",origin:"https://www.threads.net",pragma:"no-cache","Sec-Fetch-Site":"same-origin","x-asbd-id":"129477","x-fb-lsd":c.fbLSDToken,"x-ig-app-id":"238260118697367"},e?{referer:"https://www.threads.net/@"+e}:void 0)};var p=this;this.getUserIDfromUsername=i(function(t,n){var r,a,s,o,i;return l(this,function(l){switch(l.label){case 0:return[4,e.default.get("https://www.instagram.com/"+t,u({},n,{httpAgent:p.httpAgent,httpsAgent:p.httpsAgent,headers:u({},p._getDefaultHeaders(t),{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"ko,en;q=0.9,ko-KR;q=0.8,ja;q=0.7",Authorization:void 0,referer:"https://www.instagram.com/","sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"cross-site","sec-fetch-user":"?1","upgrade-insecure-requests":"1","x-asbd-id":void 0,"x-fb-lsd":void 0,"x-ig-app-id":void 0})}))];case 1:return o=null==(r=(s=(s=(s=l.sent().data).replace(/\s/g,"")).replace(/\n/g,"")).match(/"user_id":"(\d+)",/))?void 0:r[1],i=null==(a=s.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:a[1],!p.noUpdateLSD&&i&&(p.fbLSDToken=i,p.verbose&&console.debug("[fbLSDToken] UPDATED",p.fbLSDToken)),[2,o]}})});var h=this;this.getUserProfile=i(function(t,n,r){return l(this,function(a){switch(a.label){case 0:return h.verbose&&console.debug("[fbLSDToken] USING",h.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:h.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"23996318473300828"}),u({},r,{httpAgent:h.httpAgent,httpsAgent:h.httpsAgent,headers:u({},h._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileRootQuery"})}))];case 1:return[2,a.sent().data.data.userData.user]}})});var f=this;this.getUserProfileThreads=i(function(t,n,r){var a,s;return l(this,function(o){switch(o.label){case 0:return f.verbose&&console.debug("[fbLSDToken] USING",f.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:f.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"6232751443445612"}),u({},r,{httpAgent:f.httpAgent,httpsAgent:f.httpsAgent,headers:u({},f._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileThreadsTabQuery"})}))];case 1:return[2,(null==(s=o.sent().data.data)?void 0:null==(a=s.mediaData)?void 0:a.threads)||[]]}})});var g=this;this.getUserProfileReplies=i(function(t,n,r){var a,s;return l(this,function(o){switch(o.label){case 0:return g.verbose&&console.debug("[fbLSDToken] USING",g.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:g.fbLSDToken,variables:'{"userID":"'+n+'"}',doc_id:"6684830921547925"}),u({},r,{httpAgent:g.httpAgent,httpsAgent:g.httpsAgent,headers:u({},g._getDefaultHeaders(t),{"x-fb-friendly-name":"BarcelonaProfileRepliesTabQuery"})}))];case 1:return[2,(null==(s=o.sent().data.data)?void 0:null==(a=s.mediaData)?void 0:a.threads)||[]]}})});var b=this;this.getPostIDfromThreadID=i(function(e,t){var n;return l(this,function(r){return n="https://www.threads.net/t/"+(e=(e=(e=e.split("?")[0]).replace(/\s/g,"")).replace(/\//g,"")),[2,b.getPostIDfromURL(n,t)]})});var v=this;this.getPostIDfromURL=i(function(t,n){var r,a,s,o,i;return l(this,function(l){switch(l.label){case 0:return[4,e.default.get(t,u({},n,{httpAgent:v.httpAgent,httpsAgent:v.httpsAgent}))];case 1:return o=null==(r=(s=(s=(s=l.sent().data).replace(/\s/g,"")).replace(/\n/g,"")).match(/{"post_id":"(.*?)"}/))?void 0:r[1],i=null==(a=s.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:a[1],!v.noUpdateLSD&&i&&(v.fbLSDToken=i,v.verbose&&console.debug("[fbLSDToken] UPDATED",v.fbLSDToken)),[2,o]}})});var m=this;this.getThreads=i(function(t,n){return l(this,function(r){switch(r.label){case 0:return m.verbose&&console.debug("[fbLSDToken] USING",m.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:m.fbLSDToken,variables:'{"postID":"'+t+'"}',doc_id:"5587632691339264"}),u({},n,{httpAgent:m.httpAgent,httpsAgent:m.httpsAgent,headers:u({},m._getDefaultHeaders(),{"x-fb-friendly-name":"BarcelonaPostPageQuery"})}))];case 1:return[2,r.sent().data.data.data]}})});var _=this;this.getThreadLikers=i(function(t,n){return l(this,function(r){switch(r.label){case 0:return _.verbose&&console.debug("[fbLSDToken] USING",_.fbLSDToken),[4,e.default.post("https://www.threads.net/api/graphql",new URLSearchParams({lsd:_.fbLSDToken,variables:'{"mediaID":"'+t+'"}',doc_id:"9360915773983802"}),u({},n,{httpAgent:_.httpAgent,httpsAgent:_.httpsAgent,headers:_._getDefaultHeaders()}))];case 1:return[2,r.sent().data.data.likers]}})});var D=this;this.getToken=i(function(){var t,n,r,s,o;return l(this,function(i){switch(i.label){case 0:if(D.token)return D.verbose&&console.debug("[token] USING",D.token),[2,D.token];if(!D.username||!D.password)throw Error("Username and password are required");return t=encodeURIComponent(JSON.stringify({client_input_params:{password:D.password,contact_point:D.username,device_id:""+D.deviceID},server_params:{credential_type:"password",device_id:""+D.deviceID}})),r=encodeURIComponent(JSON.stringify({bloks_version:n="5f56efad68e1edec7801f630b5c122704ec5378adbee6609a448f105f34a9c73",styles_id:"instagram"})),s={method:"POST",headers:D._getAppHeaders(),responseType:"text",data:"params="+t+"&bk_client_context="+r+"&bloks_versioning_id="+n},[4,(0,e.default)(a.LOGIN_URL,s)];case 1:return o=i.sent().data.split("Bearer IGT:2:")[1].split('"')[0].replaceAll("\\",""),D.noUpdateToken||(D.verbose&&console.debug("[token] UPDATED",o),D.token=o),[2,o]}})});var w=this;this.publish=i(function(t){var n,r,s,o,i,u,d,c;return l(this,function(l){switch(l.label){case 0:if(n="string"==typeof t?{text:t}:t,!w.username||!w.password)throw Error("Username or password not set");return[4,w.getUserIDfromUsername(w.username)];case 1:if(!(r=l.sent()))throw Error("User ID not found");return[4,w.getToken()];case 2:if(!l.sent())throw Error("Token not found");if(o={text_post_app_info:{reply_control:0},timezone_offset:(-(60*(s=new Date).getTimezoneOffset())).toString(),source_type:"4",_uid:r,device_id:w.deviceID,caption:n.text||"",upload_id:s.getTime(),device:w.device},i=a.POST_URL,!("image"in n&&n.image))return[3,4];return i=a.POST_WITH_IMAGE_URL,[4,w.uploadImage(n.image)];case 3:return u=l.sent().upload_id,o.upload_id=u,o.scene_capture_type="",[3,5];case 4:"url"in n&&n.url&&(o.text_post_app_info.link_attachment_url=n.url),l.label=5;case 5:return n.parentPostID&&(o.text_post_app_info.reply_id=n.parentPostID),n.image||(o.publish_mode="text_post"),d="signed_body=SIGNATURE."+encodeURIComponent(JSON.stringify(o)),[4,e.default.post(i,d,{httpAgent:w.httpAgent,httpsAgent:w.httpsAgent,headers:w._getAppHeaders(),timeout:6e4})];case 6:if(c=l.sent(),w.verbose&&console.debug("[PUBLISH]",c.data),"ok"===c.data.status)return[2,!0];return[2,!1]}})});var S=this;this.publishWithImage=i(function(e,t){return l(this,function(n){return[2,S.publish({text:e,image:t})]})});var A=this;this.uploadImage=i(function(a){var s,o,i,d,c,p,h,f,g,b,v;return l(this,function(l){switch(l.label){case 0:if(i="https://www.instagram.com/rupload_igphoto/"+(o=(s=Date.now().toString())+"_0_"+Math.floor(9e9*Math.random()+1e9)),a.startsWith("http"))return[3,2];return[4,t.promises.readFile(a)];case 1:return d=l.sent(),c=n.default.lookup(a)||"application/octet-stream",[3,4];case 2:return[4,e.default.get(a,{responseType:"arraybuffer"})];case 3:p=l.sent(),d=Buffer.from(p.data,"binary"),c=p.headers["content-type"],l.label=4;case 4:h={upload_id:s,media_type:"1",sticker_burnin_params:JSON.stringify([]),image_compression:JSON.stringify({lib_name:"moz",lib_version:"3.1.m",quality:"80"}),xsharing_user_ids:JSON.stringify([]),retry_context:JSON.stringify({num_step_auto_retry:"0",num_reupload:"0",num_step_manual_retry:"0"}),"IG-FB-Xpost-entry-point-v2":"feed"},f=d.length,g=u({},A._getDefaultHeaders(),{"Content-Type":"application/octet-stream",X_FB_PHOTO_WATERFALL_ID:(0,r.v4)(),"X-Entity-Type":void 0!==c?"image/"+c:"image/jpeg",Offset:"0","X-Instagram-Rupload-Params":JSON.stringify(h),"X-Entity-Name":o,"X-Entity-Length":f.toString(),"Content-Length":f.toString(),"Accept-Encoding":"gzip"}),A.verbose&&console.log("[UPLOAD_IMAGE] Uploading "+f.toLocaleString()+"b as "+s+"..."),l.label=5;case 5:return l.trys.push([5,7,,8]),[4,e.default.post(i,d,{httpAgent:A.httpAgent,headers:g,timeout:6e4})];case 6:return b=l.sent().data,A.verbose&&console.log("[UPLOAD_IMAGE] SUCCESS",b),[2,b];case 7:throw v=l.sent(),A.verbose&&console.log("[UPLOAD_IMAGE] FAILED",v.response.data),v;case 8:return[2]}})}),(null==o?void 0:o.token)&&(this.token=o.token),(null==o?void 0:o.fbLSDToken)&&(this.fbLSDToken=o.fbLSDToken),this.noUpdateToken=!!(null==o?void 0:o.noUpdateToken),this.noUpdateLSD=!!(null==o?void 0:o.noUpdateLSD),this.verbose=(null==o?void 0:o.verbose)||!1,this.httpAgent=null==o?void 0:o.httpAgent,this.httpsAgent=null==o?void 0:o.httpsAgent,this.username=null==o?void 0:o.username,this.password=null==o?void 0:o.password,(null==o?void 0:o.deviceID)&&(this.deviceID=o.deviceID),this.device=null==o?void 0:o.device};