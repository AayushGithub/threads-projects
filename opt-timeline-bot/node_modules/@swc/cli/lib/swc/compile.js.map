{"version":3,"sources":["../../src/swc/compile.ts"],"sourcesContent":["import slash from \"slash\";\nimport { promises } from \"fs\";\nimport { dirname, relative } from \"path\";\nimport { transformFile, transformFileSync } from \"@swc/core\";\nimport type { Options, Output } from \"@swc/core\";\n\nconst { mkdir, stat, writeFile } = promises;\n\nfunction withSourceMap(\n  output: Output,\n  options: Options,\n  destFile: string,\n  destDir: string\n) {\n  if (!output.map || options.sourceMaps === \"inline\") {\n    return {\n      sourceCode: output.code,\n    };\n  }\n  // TODO: remove once fixed in core https://github.com/swc-project/swc/issues/1388\n  const sourceMap = JSON.parse(output.map);\n  if (options.sourceFileName) {\n    sourceMap[\"sources\"][0] = options.sourceFileName;\n  }\n  if (options.sourceRoot) {\n    sourceMap[\"sourceRoot\"] = options.sourceRoot;\n  }\n  output.map = JSON.stringify(sourceMap);\n\n  const sourceMapPath = destFile + \".map\";\n  output.code += `\\n//# sourceMappingURL=${slash(\n    relative(destDir, sourceMapPath)\n  )}`;\n\n  return {\n    sourceMap: output.map,\n    sourceMapPath,\n    sourceCode: output.code,\n  };\n}\n\nexport async function outputResult(\n  output: Output,\n  sourceFile: string,\n  destFile: string,\n  options: Options\n) {\n  const destDir = dirname(destFile);\n\n  const { sourceMap, sourceMapPath, sourceCode } = withSourceMap(\n    output,\n    options,\n    destFile,\n    destDir\n  );\n\n  await mkdir(destDir, { recursive: true });\n  const { mode } = await stat(sourceFile);\n\n  if (!sourceMapPath) {\n    await writeFile(destFile, sourceCode, { mode });\n  } else {\n    await Promise.all([\n      writeFile(destFile, sourceCode, { mode }),\n      writeFile(sourceMapPath, sourceMap, { mode }),\n    ]);\n  }\n}\n\nexport async function compile(\n  filename: string,\n  opts: Options,\n  sync: boolean,\n  outputPath: string | undefined\n): Promise<Output | void> {\n  const options = { ...opts };\n  if (outputPath) {\n    options.outputPath = outputPath;\n  }\n\n  try {\n    const result = sync\n      ? transformFileSync(filename, options)\n      : await transformFile(filename, options);\n\n    return result;\n  } catch (err: any) {\n    if (!err.message.includes(\"ignored by .swcrc\")) {\n      throw err;\n    }\n  }\n}\n"],"names":["outputResult","compile","mkdir","stat","writeFile","promises","withSourceMap","output","options","destFile","destDir","map","sourceMaps","sourceCode","code","sourceMap","JSON","parse","sourceFileName","sourceRoot","stringify","sourceMapPath","slash","relative","sourceFile","dirname","recursive","mode","Promise","all","filename","opts","sync","outputPath","result","transformFileSync","transformFile","err","message","includes"],"mappings":";;;;;;;;;;;IAyCsBA,YAAY,MAAZA;IA4BAC,OAAO,MAAPA;;4DArEJ;oBACO;sBACS;sBACe;;;;;;AAGjD,MAAM,EAAEC,MAAK,EAAEC,KAAI,EAAEC,UAAS,EAAE,GAAGC,YAAQ;AAE3C,SAASC,cACPC,MAAc,EACdC,OAAgB,EAChBC,QAAgB,EAChBC,OAAe,EACf;IACA,IAAI,CAACH,OAAOI,GAAG,IAAIH,QAAQI,UAAU,KAAK,UAAU;QAClD,OAAO;YACLC,YAAYN,OAAOO,IAAI;QACzB;IACF,CAAC;IACD,iFAAiF;IACjF,MAAMC,YAAYC,KAAKC,KAAK,CAACV,OAAOI,GAAG;IACvC,IAAIH,QAAQU,cAAc,EAAE;QAC1BH,SAAS,CAAC,UAAU,CAAC,EAAE,GAAGP,QAAQU,cAAc;IAClD,CAAC;IACD,IAAIV,QAAQW,UAAU,EAAE;QACtBJ,SAAS,CAAC,aAAa,GAAGP,QAAQW,UAAU;IAC9C,CAAC;IACDZ,OAAOI,GAAG,GAAGK,KAAKI,SAAS,CAACL;IAE5B,MAAMM,gBAAgBZ,WAAW;IACjCF,OAAOO,IAAI,IAAI,CAAC,uBAAuB,EAAEQ,IAAAA,cAAK,EAC5CC,IAAAA,cAAQ,EAACb,SAASW,gBAClB,CAAC;IAEH,OAAO;QACLN,WAAWR,OAAOI,GAAG;QACrBU;QACAR,YAAYN,OAAOO,IAAI;IACzB;AACF;AAEO,eAAed,aACpBO,MAAc,EACdiB,UAAkB,EAClBf,QAAgB,EAChBD,OAAgB,EAChB;IACA,MAAME,UAAUe,IAAAA,aAAO,EAAChB;IAExB,MAAM,EAAEM,UAAS,EAAEM,cAAa,EAAER,WAAU,EAAE,GAAGP,cAC/CC,QACAC,SACAC,UACAC;IAGF,MAAMR,MAAMQ,SAAS;QAAEgB,WAAW,IAAI;IAAC;IACvC,MAAM,EAAEC,KAAI,EAAE,GAAG,MAAMxB,KAAKqB;IAE5B,IAAI,CAACH,eAAe;QAClB,MAAMjB,UAAUK,UAAUI,YAAY;YAAEc;QAAK;IAC/C,OAAO;QACL,MAAMC,QAAQC,GAAG,CAAC;YAChBzB,UAAUK,UAAUI,YAAY;gBAAEc;YAAK;YACvCvB,UAAUiB,eAAeN,WAAW;gBAAEY;YAAK;SAC5C;IACH,CAAC;AACH;AAEO,eAAe1B,QACpB6B,QAAgB,EAChBC,IAAa,EACbC,IAAa,EACbC,UAA8B,EACN;IACxB,MAAMzB,UAAU;QAAE,GAAGuB,IAAI;IAAC;IAC1B,IAAIE,YAAY;QACdzB,QAAQyB,UAAU,GAAGA;IACvB,CAAC;IAED,IAAI;QACF,MAAMC,SAASF,OACXG,IAAAA,uBAAiB,EAACL,UAAUtB,WAC5B,MAAM4B,IAAAA,mBAAa,EAACN,UAAUtB,QAAQ;QAE1C,OAAO0B;IACT,EAAE,OAAOG,KAAU;QACjB,IAAI,CAACA,IAAIC,OAAO,CAACC,QAAQ,CAAC,sBAAsB;YAC9C,MAAMF,IAAI;QACZ,CAAC;IACH;AACF"}