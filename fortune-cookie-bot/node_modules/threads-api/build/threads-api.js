"use strict";!function(e,t){for(var r in t)Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}(exports,{DEFAULT_DEVICE:function(){return l},ThreadsAPI:function(){return d}});var e=require("axios"),t=require("crypto"),r=require("mrmime"),n=require("uuid"),s=require("./constants"),a=require("./dynamic-data");function o(e,t,r,n,s,a,o){try{var i=e[a](o),u=i.value}catch(e){r(e);return}i.done?t(u):Promise.resolve(u).then(n,s)}function i(e){return function(){var t=this,r=arguments;return new Promise(function(n,s){var a=e.apply(t,r);function i(e){o(a,n,s,i,u,"next",e)}function u(e){o(a,n,s,i,u,"throw",e)}i(void 0)})}}function u(){return(u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function c(e,t){var r,n,s,a,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(r)throw TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(s=2&a[0]?n.return:a[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,a[1])).done)return s;switch(n=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,n=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===a[0]||2===a[0])){o=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){o.label=a[1];break}if(6===a[0]&&o.label<s[1]){o.label=s[1],s=a;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(a);break}s[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(e){a=[6,e],n=0}finally{r=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}var l={manufacturer:"OnePlus",model:"ONEPLUS+A3010",os_version:25,os_release:"7.1.1"},d=function(){"use strict";function o(o){var d=this;this.verbose=!1,this.token=void 0,this.fbLSDToken=s.DEFAULT_LSD_TOKEN,this.noUpdateToken=!1,this.noUpdateLSD=!1,this.deviceID=s.DEFAULT_DEVICE_ID,this.device=l,this.userID=void 0;var h=this;this.syncLoginExperiments=i(function(){var t,r,a;return c(this,function(o){switch(o.label){case 0:r={id:t=(0,n.v4)(),experiments:s.LOGIN_EXPERIMENTS},o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e.default.post(""+s.BASE_API_URL+"/api/v1/qe/sync/",h.sign(r),{headers:u({},h._getAppHeaders(),{Authorization:void 0,"Sec-Fetch-Site":"same-origin","X-DEVICE-ID":t})})];case 2:return[2,o.sent()];case 3:throw a=o.sent(),h.verbose&&console.log("[SYNC LOGIN EXPERIMENT FAILED]",a.response.data),a;case 4:return[2]}})});var p=this;this.encryptPassword=i(function(e){var r,n,s,a,o,i,u,l,d,h,f;return c(this,function(c){switch(c.label){case 0:return r=t.randomBytes(32),n=t.randomBytes(12),[4,p.syncLoginExperiments()];case 1:return s=c.sent().headers,p.verbose&&console.log("[SYNC LOGIN EXPERIMENT HEADERS]",JSON.stringify(s)),a=s["ig-set-password-encryption-key-id"],o=s["ig-set-password-encryption-pub-key"],i=t.publicEncrypt({key:Buffer.from(o||"","base64").toString(),padding:t.constants.RSA_PKCS1_PADDING},r),u=t.createCipheriv("aes-256-gcm",r,n),l=Math.floor(Date.now()/1e3).toString(),u.setAAD(Buffer.from(l)),d=Buffer.concat([u.update(e,"utf8"),u.final()]),(h=Buffer.alloc(2,0)).writeInt16LE(i.byteLength,0),f=u.getAuthTag(),[2,{time:l,password:Buffer.concat([Buffer.from([1,a||0]),n,h,i,f,d]).toString("base64")}]}})});var f=this;this.login=i(function(){var t,r,n,a,o,i,u,l,d;return c(this,function(c){switch(c.label){case 0:return f.verbose&&console.log("[LOGIN] Logging in..."),[4,f.encryptPassword(f.password)];case 1:return r=encodeURIComponent(JSON.stringify({client_input_params:{password:"#PWD_INSTAGRAM:4:"+(t=c.sent()).time+":"+t.password,contact_point:f.username,device_id:f.deviceID},server_params:{credential_type:"password",device_id:f.deviceID}})),a=encodeURIComponent(JSON.stringify({bloks_version:n="5f56efad68e1edec7801f630b5c122704ec5378adbee6609a448f105f34a9c73",styles_id:"instagram"})),o={method:"POST",headers:f._getAppHeaders(),responseType:"text",data:"params="+r+"&bk_client_context="+a+"&bloks_versioning_id="+n},[4,(0,e.default)(""+s.BASE_API_URL+"/api/v1/bloks/apps/com.bloks.www.bloks.caa.login.async.send_login_request/",o)];case 2:i=JSON.stringify((i=c.sent().data).replaceAll("\\","")),f.verbose&&console.log("[LOGIN] Cleaned output",i);try{return l=i.split("Bearer IGT:2:")[1].split('"')[0].replaceAll("\\",""),d=null==(u=i.match(/pk_id":"(\d+)/))?void 0:u[1],f.noUpdateToken||(f.verbose&&console.debug("[token] UPDATED",l),f.token=l),f.userID=d,f.verbose&&console.debug("[userID] UPDATED",f.userID),[2,{token:l,userID:d}]}catch(e){throw f.verbose&&console.error("[LOGIN] Failed to login",e),e}return[2]}})}),this._getAppHeaders=function(){return u({"User-Agent":"Barcelona "+a.LATEST_ANDROID_APP_VERSION+" Android","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},d.token?{Authorization:"Bearer IGT:2:"+d.token}:void 0)},this._getDefaultHeaders=function(e){return u({},d._getAppHeaders(),{authority:"www.threads.net",accept:"*/*","accept-language":"ko","cache-control":"no-cache",origin:"https://www.threads.net",pragma:"no-cache","Sec-Fetch-Site":"same-origin","x-asbd-id":"129477","x-fb-lsd":d.fbLSDToken,"x-ig-app-id":"238260118697367"},e?{referer:"https://www.threads.net/@"+e}:void 0)};var g=this;this.getProfilePage=i(function(t,r,n){return c(this,function(s){switch(s.label){case 0:return[4,e.default.get(""+t+r,u({},n,{httpAgent:g.httpAgent,httpsAgent:g.httpsAgent,headers:u({},g._getDefaultHeaders(r),{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7","accept-language":"ko,en;q=0.9,ko-KR;q=0.8,ja;q=0.7",Authorization:void 0,referer:"https://www.instagram.com/","sec-fetch-dest":"document","sec-fetch-mode":"navigate","sec-fetch-site":"cross-site","sec-fetch-user":"?1","upgrade-insecure-requests":"1","x-asbd-id":void 0,"x-fb-lsd":void 0,"x-ig-app-id":void 0})}))];case 1:return[2,(0,s.sent().data).replace(/\s/g,"").replace(/\n/g,"")]}})});var v=this;this.getUserIDfromUsernameWithInstagram=i(function(e,t){var r,n,s,a,o;return c(this,function(i){switch(i.label){case 0:return[4,v.getProfilePage("https://www.instagram.com/",e,t)];case 1:return a=null==(r=(s=i.sent()).match(/"user_id":"(\d+)",/))?void 0:r[1],o=null==(n=s.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:n[1],!v.noUpdateLSD&&o&&(v.fbLSDToken=o,v.verbose&&console.debug("[fbLSDToken] UPDATED",v.fbLSDToken)),[2,a]}})});var b=this;this.getUserIDfromUsername=i(function(e,t){var r,n,s,a,o;return c(this,function(i){switch(i.label){case 0:return[4,b.getProfilePage("https://www.threads.net/@",e,t)];case 1:if(a=null==(r=(s=i.sent()).match(/"user_id":"(\d+)"/))?void 0:r[1],o=null==(n=s.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:n[1],!a)return[2,b.getUserIDfromUsernameWithInstagram(e,t)];return!b.noUpdateLSD&&o&&(b.fbLSDToken=o,b.verbose&&console.debug("[fbLSDToken] UPDATED",b.fbLSDToken)),[2,a]}})});var _=this;this.getCurrentUserID=i(function(e){var t;return c(this,function(r){switch(r.label){case 0:if(_.userID)return _.verbose&&console.debug("[userID] USING",_.userID),[2,_.userID];if(!_.username)throw Error("username is not defined");r.label=1;case 1:return r.trys.push([1,3,,5]),[4,_.getUserIDfromUsername(_.username,e)];case 2:return _.userID=r.sent(),_.verbose&&console.debug("[userID] UPDATED",_.userID),[2,_.userID];case 3:return t=r.sent(),_.verbose&&console.error("[userID] Failed to fetch userID, Fallbacking to login",t),[4,_.login()];case 4:return[2,r.sent().userID];case 5:return[2]}})}),this._requestQuery=function(t,r,n){return e.default.post(t,new URLSearchParams(r),u({httpAgent:d.httpAgent,httpsAgent:d.httpsAgent,headers:d._getDefaultHeaders()},n))},this._destructureFromUserIDQuerier=function(e){var t,r;return"string"==typeof e[0]&&"string"==typeof e[1]?(t=e[1],r=e[2]):(t=e[0],r=e[1]),{userID:t,options:r}};var D=this;this.getUserProfile=i(function(){var e,t,r,n,s,a,o=arguments;return c(this,function(i){switch(i.label){case 0:for(t=Array(e=o.length),r=0;r<e;r++)t[r]=o[r];return s=(n=D._destructureFromUserIDQuerier(t)).userID,a=n.options,D.verbose&&console.debug("[fbLSDToken] USING",D.fbLSDToken),[4,D._requestQuery("https://www.threads.net/api/graphql",{lsd:D.fbLSDToken,variables:JSON.stringify({userID:s}),doc_id:"23996318473300828"},a)];case 1:return[2,i.sent().data.data.userData.user]}})});var m=this;this.getUserProfileThreads=i(function(){var e,t,r,n,s,a,o,i,u=arguments;return c(this,function(c){switch(c.label){case 0:for(t=Array(e=u.length),r=0;r<e;r++)t[r]=u[r];return o=(a=m._destructureFromUserIDQuerier(t)).userID,i=a.options,m.verbose&&console.debug("[fbLSDToken] USING",m.fbLSDToken),[4,m._requestQuery("https://www.threads.net/api/graphql",{lsd:m.fbLSDToken,variables:JSON.stringify({userID:o}),doc_id:"6232751443445612"},i)];case 1:return[2,(null==(s=c.sent().data.data)?void 0:null==(n=s.mediaData)?void 0:n.threads)||[]]}})});var I=this;this.getUserProfileReplies=i(function(){var e,t,r,n,s,a,o,i,u=arguments;return c(this,function(c){switch(c.label){case 0:for(t=Array(e=u.length),r=0;r<e;r++)t[r]=u[r];return o=(a=I._destructureFromUserIDQuerier(t)).userID,i=a.options,I.verbose&&console.debug("[fbLSDToken] USING",I.fbLSDToken),[4,I._requestQuery("https://www.threads.net/api/graphql",{lsd:I.fbLSDToken,variables:JSON.stringify({userID:o}),doc_id:"6684830921547925"},i)];case 1:return[2,(null==(s=c.sent().data.data)?void 0:null==(n=s.mediaData)?void 0:n.threads)||[]]}})});var w=this;this.getPostIDfromThreadID=i(function(e,t){var r;return c(this,function(n){return r="https://www.threads.net/t/"+(e=(e=(e=e.split("?")[0]).replace(/\s/g,"")).replace(/\//g,"")),[2,w.getPostIDfromURL(r,t)]})});var S=this;this.getPostIDfromURL=i(function(t,r){var n,s,a,o,i;return c(this,function(c){switch(c.label){case 0:return[4,e.default.get(t,u({},r,{httpAgent:S.httpAgent,httpsAgent:S.httpsAgent}))];case 1:return o=null==(n=(a=(a=(a=c.sent().data).replace(/\s/g,"")).replace(/\n/g,"")).match(/{"post_id":"(.*?)"}/))?void 0:n[1],i=null==(s=a.match(/"LSD",\[\],{"token":"(\w+)"},\d+\]/))?void 0:s[1],!S.noUpdateLSD&&i&&(S.fbLSDToken=i,S.verbose&&console.debug("[fbLSDToken] UPDATED",S.fbLSDToken)),[2,o]}})});var y=this;this.getThreads=i(function(e,t){return c(this,function(r){switch(r.label){case 0:return y.verbose&&console.debug("[fbLSDToken] USING",y.fbLSDToken),[4,y._requestQuery("https://www.threads.net/api/graphql",{lsd:y.fbLSDToken,variables:JSON.stringify({postID:e}),doc_id:"5587632691339264"},t)];case 1:return[2,r.sent().data.data.data]}})});var A=this;this.getThreadLikers=i(function(e,t){return c(this,function(r){switch(r.label){case 0:return A.verbose&&console.debug("[fbLSDToken] USING",A.fbLSDToken),[4,A._requestQuery("https://www.threads.net/api/graphql",{lsd:A.fbLSDToken,variables:JSON.stringify({mediaID:e}),doc_id:"9360915773983802"},t)];case 1:return[2,r.sent().data.data.likers]}})});var k=this;this._toggleAuthPostRequest=i(function(t,r){return c(this,function(n){switch(n.label){case 0:return[4,k.getToken()];case 1:if(!n.sent())throw Error("Token not found");return[4,e.default.post(t,void 0,u({},r,{httpAgent:k.httpAgent,httpsAgent:k.httpsAgent,headers:k._getDefaultHeaders()}))];case 2:return[2,n.sent()]}})});var L=this;this.like=i(function(e,t){var r;return c(this,function(n){switch(n.label){case 0:return[4,L.getCurrentUserID()];case 1:return r=n.sent(),[4,L._toggleAuthPostRequest(s.BASE_API_URL+"/api/v1/media/"+e+"_"+r+"/like/",t)];case 2:return[2,"ok"===n.sent().data.status]}})});var T=this;this.unlike=i(function(e,t){var r;return c(this,function(n){switch(n.label){case 0:return[4,T.getCurrentUserID()];case 1:return r=n.sent(),[4,T._toggleAuthPostRequest(s.BASE_API_URL+"/api/v1/media/"+e+"_"+r+"/unlike/",t)];case 2:return[2,"ok"===n.sent().data.status]}})});var U=this;this.follow=i(function(e,t){var r;return c(this,function(n){switch(n.label){case 0:return[4,U._toggleAuthPostRequest(s.BASE_API_URL+"/api/v1/friendships/create/"+e+"/",t)];case 1:return r=n.sent(),U.verbose&&console.debug("[FOLLOW]",r.data),[2,r.data]}})});var E=this;this.unfollow=i(function(e,t){var r;return c(this,function(n){switch(n.label){case 0:return[4,E._toggleAuthPostRequest(s.BASE_API_URL+"/api/v1/friendships/destroy/"+e+"/",t)];case 1:return r=n.sent(),E.verbose&&console.debug("[UNFOLLOW]",r.data),[2,r.data]}})});var P=this;this.getToken=i(function(){return c(this,function(e){switch(e.label){case 0:if(P.token)return P.verbose&&console.debug("[token] USING",P.token),[2,P.token];if(!P.username||!P.password)throw Error("Username and password are required");return[4,P.login()];case 1:return e.sent(),[2,P.token]}})});var N=this;this.publish=i(function(t){var r,n,a,o,i,u,l,d;return c(this,function(c){switch(c.label){case 0:if(r="string"==typeof t?{text:t}:t,!N.username||!N.password)throw Error("Username or password not set");return[4,N.getCurrentUserID()];case 1:if(!(n=c.sent()))throw Error("User ID not found");return[4,N.getToken()];case 2:if(!c.sent())throw Error("Token not found");if(o={text_post_app_info:{reply_control:0},timezone_offset:(-(60*(a=new Date).getTimezoneOffset())).toString(),source_type:"4",_uid:n,device_id:N.deviceID,caption:r.text||"",upload_id:a.getTime(),device:N.device},i=s.POST_URL,!("image"in r&&r.image))return[3,4];return i=s.POST_WITH_IMAGE_URL,[4,N.uploadImage(r.image)];case 3:return u=c.sent().upload_id,o.upload_id=u,o.scene_capture_type="",[3,5];case 4:"url"in r&&r.url&&(o.text_post_app_info.link_attachment_url=r.url),c.label=5;case 5:return r.parentPostID&&(o.text_post_app_info.reply_id=r.parentPostID),r.image||(o.publish_mode="text_post"),l="signed_body=SIGNATURE."+encodeURIComponent(JSON.stringify(o)),[4,e.default.post(i,l,{httpAgent:N.httpAgent,httpsAgent:N.httpsAgent,headers:N._getAppHeaders(),timeout:6e4})];case 6:if(d=c.sent(),N.verbose&&console.debug("[PUBLISH]",d.data),"ok"===d.data.status)return[2,d.data.media.id];return[2,void 0]}})});var O=this;this.delete=i(function(t,r){var n,a;return c(this,function(o){switch(o.label){case 0:return n=s.BASE_API_URL+"/api/v1/media/"+t+"/delete/",a="signed_body=SIGNATURE."+encodeURIComponent(JSON.stringify({media_id:t,_uid:O.userID,_uuid:O.deviceID})),[4,e.default.post(n,a,u({httpAgent:O.httpAgent,httpsAgent:O.httpsAgent,headers:O._getAppHeaders(),timeout:6e4},r))];case 1:if("ok"===o.sent().data.status)return[2,!0];return[2,!1]}})});var R=this;this.publishWithImage=i(function(e,t){return c(this,function(r){return[2,R.publish({text:e,image:t})]})});var q=this;this.uploadImage=i(function(t){var s,a,o,i,l,d,h,p,f,g,v,b;return c(this,function(c){switch(c.label){case 0:if(o="https://www.instagram.com/rupload_igphoto/"+(a=(s=Date.now().toString())+"_0_"+Math.floor(9e9*Math.random()+1e9)),!("string"==typeof t||"path"in t))return[3,6];if((d="string"==typeof t?t:t.path).startsWith("http"))return[3,3];return[4,Promise.resolve().then(function(){return require("fs")})];case 1:return[4,c.sent().promises.readFile(d)];case 2:return i=c.sent(),l=r.default.lookup(d)||"application/octet-stream",[3,5];case 3:return[4,e.default.get(d,{responseType:"arraybuffer"})];case 4:h=c.sent(),i=Buffer.from(h.data,"binary"),l=h.headers["content-type"],c.label=5;case 5:return[3,7];case 6:i=t.data,l=(t.type.includes("/")?t.type:r.default.lookup(t.type))||"application/octet-stream",c.label=7;case 7:p={upload_id:s,media_type:"1",sticker_burnin_params:JSON.stringify([]),image_compression:JSON.stringify({lib_name:"moz",lib_version:"3.1.m",quality:"80"}),xsharing_user_ids:JSON.stringify([]),retry_context:JSON.stringify({num_step_auto_retry:"0",num_reupload:"0",num_step_manual_retry:"0"}),"IG-FB-Xpost-entry-point-v2":"feed"},f=i.length,g=u({},q._getDefaultHeaders(),{"Content-Type":"application/octet-stream",X_FB_PHOTO_WATERFALL_ID:(0,n.v4)(),"X-Entity-Type":void 0!==l?"image/"+l:"image/jpeg",Offset:"0","X-Instagram-Rupload-Params":JSON.stringify(p),"X-Entity-Name":a,"X-Entity-Length":f.toString(),"Content-Length":f.toString(),"Accept-Encoding":"gzip"}),q.verbose&&console.log("[UPLOAD_IMAGE] Uploading "+f.toLocaleString()+"b as "+s+"..."),c.label=8;case 8:return c.trys.push([8,10,,11]),[4,e.default.post(o,i,{httpAgent:q.httpAgent,headers:g,timeout:6e4})];case 9:return v=c.sent().data,q.verbose&&console.log("[UPLOAD_IMAGE] SUCCESS",v),[2,v];case 10:throw b=c.sent(),q.verbose&&console.log("[UPLOAD_IMAGE] FAILED",b.response.data),b;case 11:return[2]}})}),(null==o?void 0:o.token)&&(this.token=o.token),(null==o?void 0:o.fbLSDToken)&&(this.fbLSDToken=o.fbLSDToken),this.noUpdateToken=!!(null==o?void 0:o.noUpdateToken),this.noUpdateLSD=!!(null==o?void 0:o.noUpdateLSD),this.verbose=(null==o?void 0:o.verbose)||!1,this.httpAgent=null==o?void 0:o.httpAgent,this.httpsAgent=null==o?void 0:o.httpsAgent,this.username=null==o?void 0:o.username,this.password=null==o?void 0:o.password,(null==o?void 0:o.deviceID)&&(this.deviceID=o.deviceID),this.device=null==o?void 0:o.device,this.userID=null==o?void 0:o.userID}return o.prototype.sign=function(e){var r="object"==typeof e?JSON.stringify(e):e;return{ig_sig_key_version:4,signed_body:t.createHmac("sha256",s.SIGNATURE_KEY).update(r).digest("hex")+"."+r}},o}();